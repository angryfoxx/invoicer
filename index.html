<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice</title>
    <style>
        :root { --main-text: #343a40; --secondary-text: #495057; --border-color: #dee2e6; --bg-light: #f8f9fa; }
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: var(--bg-light); }
        .invoice-container { max-width: 800px; margin: 2rem auto; padding: 2.5rem; background-color: white; border: 1px solid var(--border-color); box-shadow: 0 0 15px rgba(0,0,0,0.05); }
        .invoice-header, .invoice-parties { display: flex; justify-content: space-between; margin-bottom: 2.5rem; }
        .invoice-header h1 { margin: 0; font-size: 2.2em; color: var(--main-text); }
        .company-logo { max-width: 150px; max-height: 150px; }
        .invoice-meta, .company-details, .client-details { line-height: 1.6; font-size: 0.9em; }
        .invoice-meta { text-align: right; }
        .invoice-meta p, .company-details p, .client-details p { margin: 0; }
        strong { color: var(--secondary-text); }
        .invoice-table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; }
        .invoice-table th, .invoice-table td { border: 1px solid var(--border-color); padding: 0.75rem; text-align: left; }
        .invoice-table thead { background-color: var(--bg-light); font-weight: 600; }
        .invoice-table .text-right { text-align: right; }
        .invoice-totals { display: flex; justify-content: flex-end; }
        .invoice-totals table { width: 50%; max-width: 350px; }
        .invoice-totals td { padding: 0.6rem 0.75rem; }
        .invoice-totals .total td { font-weight: bold; font-size: 1.2em; border-top: 2px solid var(--main-text); }
        .invoice-footer { margin-top: 2.5rem; text-align: center; color: #868e96; font-size: 0.9em; }
        .print-button { display: block; width: 150px; margin: 2rem auto; padding: 0.75rem; font-size: 1rem; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
        
        @media print {
            @page { margin: 1cm; }
            body { background-color: white; }
            .print-button { display: none; }
            .invoice-container { box-shadow: none; border: none; margin: 0; padding: 0; max-width: 100%; }
            h1, p, th, td, strong, span { color: black !important; }
            .invoice-table thead { background-color: #e9ecef !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <button class="print-button" onclick="window.print()">Print Invoice</button>

    <div class="invoice-container">
        <header class="invoice-header">
            <div>
                <img id="companyLogo" src="" alt="Company Logo" class="company-logo" style="display: none;">
                <h1 id="invoiceTitle"></h1>
            </div>
            <div class="invoice-meta">
                <p><strong>Invoice No:</strong> <span id="invoiceNumber"></span></p>
                <p><strong>Date:</strong> <span id="invoiceDate"></span></p>
                <p><strong>Due Date:</strong> <span id="dueDate"></span></p>
            </div>
        </header>

        <section class="invoice-parties">
            <div class="company-details">
                <strong id="fromTitle"></strong>
                <p id="companyName"></p><p id="companyAddress"></p><p id="companyPhone"></p><p id="companyEmail"></p>
            </div>
            <div class="client-details">
                <strong>Bill To:</strong>
                <p id="clientName"></p><p id="clientAddress"></p><p id="clientPhone"></p><p id="clientEmail"></p>
            </div>
        </section>

        <table class="invoice-table">
            <thead><tr><th>Description</th><th>Quantity</th><th>Unit Price</th><th class="text-right">Total</th></tr></thead>
            <tbody id="invoiceItems"></tbody>
        </table>

        <section class="invoice-totals">
            <table>
                <tbody>
                    <tr><td>Subtotal</td><td id="subtotal" class="text-right"></td></tr>
                    <tr><td>Tax (<span id="taxRate">0</span>%)</td><td id="taxAmount" class="text-right"></td></tr>
                    <tr class="total"><td>Grand Total</td><td id="grandTotal" class="text-right"></td></tr>
                </tbody>
            </table>
        </section>

        <footer class="invoice-footer"><p id="footerNote"></p></footer>
    </div>

    <script>
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const currency = params.get('currencySymbol') ?? '$';

            // Compactly populate text fields from URL parameters
            const textMappings = {
                'invoiceTitle': ['title', 'INVOICE'],
                'invoiceNumber': ['invoiceNumber', 'N/A'],
                'invoiceDate': ['invoiceDate', new Date().toLocaleDateString('en-CA')], // yyyy-mm-dd format
                'dueDate': ['dueDate', 'N/A'],
                'fromTitle': ['fromTitle', 'From:'],
                'companyName': ['companyName', 'Your Company'],
                'companyAddress': ['companyAddress', '123 Business Rd.'],
                'companyPhone': ['companyPhone', ''],
                'companyEmail': ['companyEmail', ''],
                'clientName': ['clientName', 'Client Name'],
                'clientAddress': ['clientAddress', '456 Customer Ave.'],
                'clientPhone': ['clientPhone', ''],
                'clientEmail': ['clientEmail', ''],
                'footerNote': ['footerNote', 'Thank you for your business.']
            };

            for (const [id, [param, defaultValue]] of Object.entries(textMappings)) {
                document.getElementById(id).textContent = params.get(param) ?? defaultValue;
            }

            // Surface unexpected parameters to help callers debug malformed URLs.
            const expectedParams = new Set([
                ...Object.values(textMappings).map(([param]) => param),
                'currencySymbol',
                'logoUrl',
                'items',
                'taxRate'
            ]);
            const unexpectedParams = [];
            for (const key of params.keys()) {
                if (!expectedParams.has(key)) {
                    unexpectedParams.push(key);
                }
            }
            if (unexpectedParams.length) {
                console.log(`Unexpected invoice parameters: ${unexpectedParams.join(', ')}`);
            }

            // Populate logo
            const logoUrl = params.get('logoUrl');
            if (logoUrl) {
                const logo = document.getElementById('companyLogo');
                logo.src = logoUrl;
                logo.style.display = 'block';
            }

            // Process invoice items and calculate totals
            const itemsTbody = document.getElementById('invoiceItems');
            const itemsParam = params.get('items');
            let subtotal = 0;

            if (itemsParam) {
                try {
                    const items = JSON.parse(decodeURIComponent(itemsParam));
                    items.forEach(item => {
                        const row = itemsTbody.insertRow();
                        const itemTotal = (item.qty ?? 0) * (item.rate ?? 0);
                        subtotal += itemTotal;
                        row.innerHTML = `
                            <td>${item.desc ?? 'N/A'}</td>
                            <td>${item.qty ?? 0}</td>
                            <td>${currency}${(item.rate ?? 0).toFixed(2)}</td>
                            <td class="text-right">${currency}${itemTotal.toFixed(2)}</td>
                        `;
                    });
                } catch (e) {
                    itemsTbody.innerHTML = `<tr><td colspan="4" style="color:red;">Error parsing items. Check the 'items' parameter.</td></tr>`;
                    console.error("JSON Parse Error:", e);
                }
            }

            // Populate totals
            const taxRate = parseFloat(params.get('taxRate') ?? 0);
            const taxAmount = subtotal * (taxRate / 100);
            const grandTotal = subtotal + taxAmount;
            
            document.getElementById('taxRate').textContent = taxRate;
            document.getElementById('subtotal').textContent = `${currency}${subtotal.toFixed(2)}`;
            document.getElementById('taxAmount').textContent = `${currency}${taxAmount.toFixed(2)}`;
            document.getElementById('grandTotal').textContent = `${currency}${grandTotal.toFixed(2)}`;
        };
    </script>
</body>
</html>
